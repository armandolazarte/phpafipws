<div align="center">
    <img src="https://raw.githubusercontent.com/armandolazarte/phpafipws/master/docs/logo.png" height="200" alt="PhpAfipWs">

**SDK moderno para Web Services de AFIP en PHP**

[![Tests](https://github.com/armandolazarte/phpafipws/actions/workflows/tests.yml/badge.svg)](https://github.com/armandolazarte/phpafipws/actions)
[![Downloads](https://img.shields.io/packagist/dt/armandolazarte/phpafipws)](https://packagist.org/packages/armandolazarte/phpafipws)
[![Version](https://img.shields.io/packagist/v/armandolazarte/phpafipws)](https://packagist.org/packages/armandolazarte/phpafipws)
[![License](https://img.shields.io/packagist/l/armandolazarte/phpafipws)](https://packagist.org/packages/armandolazarte/phpafipws)
[![PHP Version](https://img.shields.io/packagist/php-v/armandolazarte/phpafipws)](https://packagist.org/packages/armandolazarte/phpafipws)
[![Test Coverage](https://img.shields.io/badge/tests-99%20passing-brightgreen)](https://github.com/armandolazarte/phpafipws)

</div>

---

## üìã Descripci√≥n

PhpAfipWs es un SDK moderno y robusto para interactuar con los Web Services de AFIP (Administraci√≥n Federal de Ingresos P√∫blicos) de Argentina. Desarrollado con PHP 8.1+, ofrece una interfaz simple y elegante para la facturaci√≥n electr√≥nica y otros servicios de AFIP.

## ‚ú® Caracter√≠sticas

-   **Moderno**: Desarrollado con PHP 8.1+ y tipado estricto
-   **F√°cil de usar**: API intuitiva y bien documentada
-   **Completo**: Soporte para m√∫ltiples Web Services de AFIP
-   **Seguro**: Manejo robusto de certificados y autenticaci√≥n
-   **Confiable**: 99 tests automatizados con Pest 4
-   **Mantenido**: Actualizaciones regulares y soporte activo

### üÜï Novedades v1.2.0

-   **Nueva clase GeneradorCertificados**: Utilidades completas para gesti√≥n de certificados y claves
    -   `generarClavePrivada()` - Generar claves privadas RSA con phpseclib3
    -   `generarCSR()` - Crear Certificate Signing Requests para AFIP
    -   `extraerInformacionCSR()` - Extraer informaci√≥n de CSRs existentes
    -   `extraerInformacionCertificado()` - Analizar certificados X.509
    -   `crearInformacionDN()` - Crear Distinguished Names v√°lidos para AFIP
    -   `validarInformacionDN()` - Validar estructura de Distinguished Names
-   **Nueva excepci√≥n CertificadoException**: Manejo espec√≠fico de errores de certificados
-   **6 ejemplos nuevos**: Gu√≠as paso a paso para generaci√≥n de certificados
-   **Integraci√≥n con phpseclib3**: Soporte nativo para operaciones criptogr√°ficas
-   **Documentaci√≥n especializada**: Gu√≠a completa en `docs/GeneradorCertificados.md`

### üîÑ Novedades anteriores v1.1.2

-   **Nuevos m√©todos CAEA**: 3 m√©todos adicionales para gesti√≥n completa de CAEA
    -   `informarCAEASinMovimiento()` - Informar CAEA sin movimiento
    -   `consultarCAEASinMovimiento()` - Consultar estado de CAEA sin movimiento
    -   `registrarComprobantesConCAEA()` - Registrar comprobantes emitidos con CAEA
-   **Nuevos m√©todos de consulta**: 2 m√©todos para informaci√≥n adicional
    -   `obtenerCotizacionMoneda()` - Obtener cotizaci√≥n oficial de monedas
    -   `obtenerActividades()` - Consultar actividades econ√≥micas del emisor
-   **Ejemplos ampliados**: 24 ejemplos pr√°cticos cubriendo 100% de los 22 m√©todos disponibles
-   **Tests actualizados**: Suite de tests expandida con cobertura completa de nuevos m√©todos
-   **Documentaci√≥n completa**: Gu√≠as detalladas y casos de uso para todos los m√©todos

## üöÄ Instalaci√≥n

Instala el paquete usando Composer:

```bash
composer require armandolazarte/phpafipws
```

## üì¶ Requisitos

-   PHP >= 8.1
-   Extensi√≥n SOAP
-   Extensi√≥n OpenSSL
-   Extensi√≥n SimpleXML
-   Certificado digital de AFIP
-   Clave privada correspondiente

### Dependencias Opcionales

-   **phpseclib/phpseclib:~3.0** - Para generar certificados y claves con `GeneradorCertificados`

## üîß Configuraci√≥n Inicial

### 1. Obtener Certificados

Tienes dos opciones para obtener certificados:

#### Opci√≥n A: Generar con GeneradorCertificados (Recomendado)

```php
use PhpAfipWs\Authorization\GeneradorCertificados;

// 1. Generar clave privada
$clavePrivada = GeneradorCertificados::generarClavePrivada(2048, 'mi_frase_secreta');
file_put_contents('clave_privada.key', $clavePrivada);

// 2. Crear informaci√≥n DN
$dn = GeneradorCertificados::crearInformacionDN(
    cuit: '20123456789',
    nombreOrganizacion: 'Mi Empresa S.A.',
    nombreComun: 'mi_empresa'
);

// 3. Generar CSR
$csr = GeneradorCertificados::generarCSR('clave_privada.key', $dn);
file_put_contents('certificado.csr', $csr);

// 4. Subir CSR a AFIP y descargar certificado
```

#### Opci√≥n B: Proceso Manual

1. Genera una clave privada y CSR con herramientas externas
2. Solicita el certificado en el sitio de AFIP
3. Descarga el certificado (.crt) y guarda tu clave privada (.key)

### 2. Estructura de Carpetas

```
tu-proyecto/
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îú‚îÄ‚îÄ certificado.crt
‚îÇ   ‚îî‚îÄ‚îÄ clave_privada.key
‚îî‚îÄ‚îÄ ta/
    ‚îî‚îÄ‚îÄ (archivos de tickets de acceso)
```

## üíª Uso B√°sico

### Inicializaci√≥n

```php
<?php

use PhpAfipWs\Afip;

$afip = new Afip([
    'cuit' => 20123456789,
    'modo_produccion' => false, // true para producci√≥n
    'nombre_certificado' => 'certificado.crt',
    'nombre_clave' => 'clave_privada.key',
    'contrasena_clave' => 'tu_passphrase', // opcional
    'carpeta_recursos' => __DIR__ . '/resources/',
    'carpeta_ta' => __DIR__ . '/ta/',
]);
```

### Facturaci√≥n Electr√≥nica

#### M√©todo Simplificado (Recomendado)

```php
// Autorizar el pr√≥ximo comprobante autom√°ticamente
$datosFactura = [
    'PtoVta' => 1,
    'CbteTipo' => 1, // Factura A
    'Concepto' => 1, // Productos
    'DocTipo' => 80, // CUIT
    'DocNro' => 33693450239,
    'CbteFch' => (int) date('Ymd'),
    'ImpTotal' => 121.00,
    'ImpNeto' => 100.00,
    'ImpIVA' => 21.00,
    'MonId' => 'PES',
    'MonCotiz' => 1,
    'Iva' => [
        [
            'Id' => 5, // 21%
            'BaseImp' => 100.00,
            'Importe' => 21.00,
        ],
    ],
];

// El SDK calcula autom√°ticamente el pr√≥ximo n√∫mero de comprobante
$respuesta = $afip->FacturacionElectronica->autorizarProximoComprobante($datosFactura);

if ($respuesta->FECAESolicitarResult->FeDetResp->FECAEDetResponse->Resultado === 'A') {
    echo "¬°Factura autorizada!\n";
    echo "CAE: " . $respuesta->FECAESolicitarResult->FeDetResp->FECAEDetResponse->CAE . "\n";
    echo "N√∫mero: " . $respuesta->FECAESolicitarResult->FeDetResp->FECAEDetResponse->CbteDesde . "\n";
}
```

#### M√©todo Manual (Control Total)

```php
// Obtener el √∫ltimo n√∫mero de comprobante
$ultimoNumero = $afip->FacturacionElectronica
    ->obtenerUltimoNumeroComprobante($puntoDeVenta = 1, $tipoFactura = 1);

// Crear una factura con n√∫mero espec√≠fico
$datosFactura = [
    'PtoVta' => 1,
    'CbteTipo' => 1, // Factura A
    'Concepto' => 1, // Productos
    'DocTipo' => 80, // CUIT
    'DocNro' => 33693450239,
    'CbteDesde' => $ultimoNumero + 1,
    'CbteHasta' => $ultimoNumero + 1,
    'CbteFch' => (int) date('Ymd'),
    'ImpTotal' => 121.00,
    'ImpNeto' => 100.00,
    'ImpIVA' => 21.00,
    'MonId' => 'PES',
    'MonCotiz' => 1,
    'Iva' => [
        [
            'Id' => 5, // 21%
            'BaseImp' => 100.00,
            'Importe' => 21.00,
        ],
    ],
];

// Autorizar la factura
$respuesta = $afip->FacturacionElectronica->autorizarComprobante([$datosFactura]);

if ($respuesta->FECAESolicitarResult->FeDetResp->FECAEDetResponse->Resultado === 'A') {
    echo "¬°Factura autorizada!\n";
    echo "CAE: " . $respuesta->FECAESolicitarResult->FeDetResp->FECAEDetResponse->CAE . "\n";
}
```

## üõ†Ô∏è Web Services y Utilidades Disponibles

### Web Services AFIP

-   **FacturacionElectronica**: Facturaci√≥n electr√≥nica (WSFE)
-   **PadronAlcanceCuatro**: Padr√≥n A4
-   **PadronAlcanceCinco**: Padr√≥n A5
-   **ConstanciaInscripcion**: Constancia de inscripci√≥n
-   **PadronAlcanceDiez**: Padr√≥n A10
-   **PadronAlcanceTrece**: Padr√≥n A13

### Utilidades de Certificados

-   **GeneradorCertificados**: Generaci√≥n y gesti√≥n de certificados digitales
    -   Generaci√≥n de claves privadas RSA
    -   Creaci√≥n de Certificate Signing Requests (CSR)
    -   Extracci√≥n de informaci√≥n de certificados y CSRs
    -   Validaci√≥n de Distinguished Names
    -   Utilidades de archivos para certificados

## üìö Ejemplos

El directorio `ejemplos/` contiene **30 ejemplos completos** que cubren **100% de los m√©todos** disponibles:

### Facturaci√≥n Electr√≥nica

-   Facturas A, B y C con ejemplos detallados
-   Notas de cr√©dito A, B y C
-   Gesti√≥n completa de CAEA (C√≥digo de Autorizaci√≥n Electr√≥nico Anticipado)
-   Consulta de informaci√≥n de comprobantes

### Consultas de Par√°metros

-   Tipos de comprobantes, documentos y monedas
-   Tipos de concepto y al√≠cuotas de IVA
-   Condiciones de IVA del receptor
-   Puntos de venta habilitados
-   **Tipos de datos opcionales** (CVU, CBU, Email, etc.)
-   **Tipos de tributos** (Nacionales, Provinciales, Municipales)

### M√©todos Avanzados

-   **Gesti√≥n CAEA completa**: Solicitar, consultar, informar sin movimiento y registrar comprobantes
-   **Cotizaciones de moneda**: Obtener cotizaciones oficiales de AFIP para facturaci√≥n en moneda extranjera
-   **Actividades econ√≥micas**: Consultar actividades habilitadas del emisor
-   **Nuevos m√©todos simplificados v1.1.0**: Autorizaci√≥n autom√°tica y consultas directas
-   **Estado del servidor y diagn√≥sticos**: Verificaci√≥n de disponibilidad de servicios
-   **Demostraci√≥n completa**: Ejemplos de todos los m√©todos disponibles

### Generaci√≥n de Certificados

-   **Generaci√≥n de claves privadas**: Crear claves RSA con diferentes tama√±os y frases secretas
-   **Creaci√≥n de CSRs**: Generar Certificate Signing Requests v√°lidos para AFIP
-   **Gesti√≥n de Distinguished Names**: Crear y validar informaci√≥n DN
-   **An√°lisis de certificados**: Extraer informaci√≥n de certificados X.509 existentes
-   **Flujo completo**: Proceso paso a paso desde clave privada hasta certificado final

Todos los ejemplos incluyen:

-   ‚úÖ C√≥digo funcional sin warnings
-   ‚úÖ Explicaciones detalladas de uso
-   ‚úÖ Validaciones y mejores pr√°cticas
-   ‚úÖ Funciones helper reutilizables
-   ‚úÖ Manejo robusto de errores

## üîç M√©todos √ötiles

### Informaci√≥n del SDK

```php
echo $afip->obtenerVersionSDK(); // Versi√≥n actual
echo $afip->obtenerCuit(); // CUIT configurado
echo $afip->esModoProduccion() ? 'Producci√≥n' : 'Homologaci√≥n';
```

### Generaci√≥n de Certificados

```php
use PhpAfipWs\Authorization\GeneradorCertificados;

// Generar clave privada RSA
$clavePrivada = GeneradorCertificados::generarClavePrivada(2048, 'frase_secreta');

// Crear informaci√≥n DN para AFIP
$dn = GeneradorCertificados::crearInformacionDN(
    cuit: '20123456789',
    nombreOrganizacion: 'Mi Empresa S.A.',
    nombreComun: 'mi_empresa'
);

// Generar CSR
$csr = GeneradorCertificados::generarCSR($clavePrivada, $dn);

// Extraer informaci√≥n de certificado
$info = GeneradorCertificados::extraerInformacionCertificado($certificadoPem);
echo "V√°lido hasta: " . date('Y-m-d', $info['validTo_time_t']);
```

### Facturaci√≥n Electr√≥nica - M√©todos Principales

```php
// Verificar estado del servidor AFIP
$estado = $afip->FacturacionElectronica->obtenerEstadoServidor();

// Obtener √∫ltimo n√∫mero de comprobante (m√©todo directo)
$ultimoNumero = $afip->FacturacionElectronica
    ->obtenerUltimoNumeroComprobante($puntoVenta = 1, $tipoComprobante = 1);

// Obtener respuesta completa del √∫ltimo comprobante
$ultimoComprobante = $afip->FacturacionElectronica
    ->obtenerUltimoComprobante($puntoVenta = 1, $tipoComprobante = 1);

// Autorizar comprobante con n√∫mero espec√≠fico
$respuesta = $afip->FacturacionElectronica->autorizarComprobante([$datosComprobante]);

// Autorizar pr√≥ximo comprobante autom√°ticamente (recomendado)
$respuesta = $afip->FacturacionElectronica->autorizarProximoComprobante($datosComprobante);
```

### Consultas de Par√°metros

```php
// Obtener tipos de comprobantes disponibles
$tiposComprobante = $afip->FacturacionElectronica->obtenerTiposComprobante();

// Obtener tipos de documentos
$tiposDocumento = $afip->FacturacionElectronica->obtenerTiposDocumento();

// Obtener tipos de monedas
$tiposMoneda = $afip->FacturacionElectronica->obtenerTiposMoneda();

// Obtener condiciones de IVA para el receptor
$condicionesIva = $afip->FacturacionElectronica->obtenerCondicionesIvaReceptor();
```

### Consultas de Padr√≥n

```php
// Consultar datos de un CUIT
$datos = $afip->PadronAlcanceCuatro->obtenerPersona(20123456789);
```

## ‚öôÔ∏è Configuraci√≥n Avanzada

### Carpeta WSDL Personalizada

```php
$afip = new Afip([
    // ... otras opciones
    'carpeta_wsdl' => __DIR__ . '/wsdl_personalizados/',
]);
```

### Manejo de Excepciones SOAP

```php
$afip = new Afip([
    // ... otras opciones
    'manejar_excepciones_soap' => true,
]);
```

## üö® Manejo de Errores

El SDK utiliza excepciones espec√≠ficas para diferentes tipos de errores con informaci√≥n contextual detallada:

```php
use PhpAfipWs\Exception\AfipException;
use PhpAfipWs\Exception\AutenticacionException;
use PhpAfipWs\Exception\CertificadoException;
use PhpAfipWs\Exception\ConfiguracionException;
use PhpAfipWs\Exception\ValidacionException;
use PhpAfipWs\Exception\ArchivoException;

try {
    $respuesta = $afip->FacturacionElectronica->autorizarComprobante($datos);
} catch (AutenticacionException $e) {
    echo "Error de autenticaci√≥n: " . $e->getMessage();
    echo "Servicio: " . $e->obtenerServicio();
} catch (ConfiguracionException $e) {
    echo "Error de configuraci√≥n: " . $e->getMessage();
    echo "Campo problem√°tico: " . $e->obtenerCampoConfiguracion();
} catch (ValidacionException $e) {
    echo "Error de validaci√≥n: " . $e->getMessage();
    echo "Campo: " . $e->obtenerCampo();
    echo "Valor: " . $e->obtenerValor();
} catch (CertificadoException $e) {
    echo "Error de certificado: " . $e->getMessage();
    echo "Operaci√≥n: " . $e->obtenerOperacion();
} catch (ArchivoException $e) {
    echo "Error de archivo: " . $e->getMessage();
} catch (AfipException $e) {
    echo "Error general: " . $e->getMessage();
    echo "C√≥digo: " . $e->getCode();
    echo "Tipo: " . $e->obtenerTipoError();
}
```

### Informaci√≥n Contextual

Todas las excepciones incluyen:

-   **Timestamp**: Momento exacto del error
-   **ID √∫nico**: Para tracking y debugging
-   **Contexto**: Informaci√≥n espec√≠fica del error
-   **C√≥digos estructurados**: Para manejo program√°tico

## üß™ Testing

PhpAfipWs incluye una suite completa de tests usando **Pest 4** para garantizar la calidad y confiabilidad del c√≥digo.

### Ejecutar Tests

```bash
# Todos los tests
composer test:unit

# Solo tests unitarios
./vendor/bin/pest tests/Unit

# Solo tests de integraci√≥n
./vendor/bin/pest tests/Feature

# Con informaci√≥n detallada
./vendor/bin/pest --verbose
```

### Cobertura de Tests

-   ‚úÖ **99 tests** con **295 assertions**
-   ‚úÖ Tests unitarios para todas las clases principales
-   ‚úÖ Tests de integraci√≥n para flujos completos
-   ‚úÖ Validaci√≥n de configuraciones y excepciones
-   ‚úÖ Manejo de errores y casos edge
-   ‚úÖ **Cobertura 100%** de m√©todos de Facturaci√≥n Electr√≥nica
-   ‚úÖ **34 tests espec√≠ficos** para FacturacionElectronica con 111 assertions
-   ‚úÖ Tests de casos de uso reales basados en ejemplos

### Estructura de Tests

```
tests/
‚îú‚îÄ‚îÄ Feature/           # Tests de integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ AfipIntegrationTest.php
‚îÇ   ‚îú‚îÄ‚îÄ ErrorHandlingTest.php
‚îÇ   ‚îî‚îÄ‚îÄ WebServiceAccessTest.php
‚îú‚îÄ‚îÄ Unit/              # Tests unitarios
‚îÇ   ‚îú‚îÄ‚îÄ Authorization/
‚îÇ   ‚îú‚îÄ‚îÄ Enums/
‚îÇ   ‚îú‚îÄ‚îÄ Exception/
‚îÇ   ‚îî‚îÄ‚îÄ AfipTest.php
‚îî‚îÄ‚îÄ TestCase.php       # Helpers para testing
```

### Calidad de C√≥digo

```bash
# Verificar todo (linting, types, refactoring, tests)
composer quality

# Comandos individuales
composer test:lint      # PHP CS Fixer
composer test:types     # PHPStan
composer test:refactor  # Rector

# Aplicar correcciones autom√°ticas
composer lint           # Aplicar PHP CS Fixer
composer refactor       # Aplicar Rector
```

## üîß Desarrollo

### Configuraci√≥n del Entorno de Desarrollo

```bash
# Clonar el repositorio
git clone https://github.com/armandolazarte/phpafipws.git
cd phpafipws

# Instalar dependencias
composer install

# Ejecutar tests
composer test:unit

# Verificar calidad
composer quality
```

### Debugging

Para debugging detallado, puedes acceder a informaci√≥n contextual de las excepciones:

```php
try {
    $afip = new Afip($opciones);
} catch (AfipException $e) {
    // Informaci√≥n b√°sica
    echo "Error: " . $e->getMessage() . "\n";
    echo "C√≥digo: " . $e->getCode() . "\n";

    // Informaci√≥n contextual
    echo "Tipo: " . $e->obtenerTipoError() . "\n";
    echo "ID: " . $e->obtenerId() . "\n";
    echo "Timestamp: " . $e->obtenerMarcaTiempo()->format('Y-m-d H:i:s') . "\n";

    // Contexto espec√≠fico
    print_r($e->obtenerContexto());
}
```

## üôè Agradecimientos

Este proyecto est√° basado en el excelente trabajo de [AfipSDK/afip.php](https://github.com/AfipSDK/afip.php). Agradecemos enormemente a sus contribuidores por sentar las bases que hicieron posible este SDK moderno.

## ü§ù Contribuir

Las contribuciones son bienvenidas. Por favor:

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/nueva-funcionalidad`)
3. Escribe tests para tu c√≥digo (`composer test:unit`)
4. Verifica la calidad (`composer quality`)
5. Commit tus cambios (`git commit -am 'Agrega nueva funcionalidad'`)
6. Push a la rama (`git push origin feature/nueva-funcionalidad`)
7. Abre un Pull Request

### Gu√≠as para Contribuir

-   **Tests**: Todo c√≥digo nuevo debe incluir tests
-   **Estilo**: Seguir PSR-12 y las reglas de PHP CS Fixer
-   **Tipos**: Usar tipado estricto en todo el c√≥digo
-   **Documentaci√≥n**: Actualizar README y docstrings seg√∫n corresponda

## üìÑ Licencia

Este proyecto est√° bajo la [Licencia MIT](LICENSE.md).

## üë®‚Äçüíª Autor

**[Armando Lazarte](https://x.com/ArmandoLazarte)**

---

<div align="center">

**¬øTe gusta este proyecto? ¬°Dale una ‚≠ê!**

</div>
